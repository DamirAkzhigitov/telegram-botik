# Исправление проблемы с балансами пользователей

## Проблема
Новые пользователи получают 0 монет вместо 5 монет при регистрации.

## Причины проблемы
1. SQL запрос `RETURNING *` может не работать корректно в D1 базе данных Cloudflare
2. Значение по умолчанию в схеме базы данных может не применяться при INSERT
3. Возможные проблемы с транзакциями

## Исправления

### 1. Обновлен код UserService.ts
- Убран `RETURNING *` из INSERT запроса
- Добавлена дополнительная проверка баланса после создания пользователя
- Добавлено больше логирования для отладки

### 2. Обновлена схема базы данных
- Изменен порядок `NOT NULL DEFAULT 5` на `DEFAULT 5 NOT NULL`

### 3. Добавлена команда администратора
- Команда `/fixbalances` для исправления существующих пользователей
- Требует настройки списка администраторов в `src/commands/fixBalances.ts`

### 4. Созданы скрипты для диагностики и исправления
- `scripts/check-db.sql` - проверка состояния базы данных
- `scripts/fix-existing-users.sql` - исправление существующих пользователей

## Инструкции по исправлению

### Шаг 1: Развернуть обновленный код
```bash
wrangler deploy
```

### Шаг 2: Проверить состояние базы данных
```bash
wrangler d1 execute bot-users-db --file=./scripts/check-db.sql
```

### Шаг 3: Исправить существующих пользователей
```bash
wrangler d1 execute bot-users-db --file=./scripts/fix-existing-users.sql
```

### Шаг 4: Настроить администраторов (опционально)
Отредактируйте файл `src/commands/fixBalances.ts` и замените `[123456789]` на реальные Telegram ID администраторов.

### Шаг 5: Проверить исправление
```bash
wrangler d1 execute bot-users-db --file=./scripts/check-db.sql
```

## Проверка работы

1. Отправьте сообщение боту от нового пользователя
2. Проверьте баланс командой `/balance`
3. Убедитесь, что новый пользователь получил 5 монет

## Логирование

В коде добавлено подробное логирование:
- Создание новых пользователей
- Проверка балансов
- Исправление некорректных балансов

Логи можно найти в Cloudflare Workers dashboard.

## Профилактика

1. Регулярно проверяйте состояние базы данных
2. Мониторьте логи на предмет ошибок регистрации
3. Используйте команду `/fixbalances` при необходимости

## Контакты

При возникновении проблем обращайтесь к разработчику или создайте issue в репозитории. 